<!DOCTYPE html>
<html>
	<head>
		<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
		<base href="http://{{ domain }}" />
		<title>{{ brand }}</title>
		<link rel="icon" href="{{ url_for('static', filename='image/logo.png') }}" />
		<link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.1/css/bootstrap.min.css">
		<link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-glyphicons.css') }}">
		<link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
		<!-- SoundManager2 -->
		<link rel="stylesheet" href="{{ url_for('static', filename='sm/css/bar-ui.css') }}">
		<link rel="stylesheet" href="{{ url_for('static', filename='sm/css/demo.css') }}">
	</head>
	<body>
		<hearder>
			{% include "header.html" %}
		</hearder>
		<div class="container" id="main">
			{% include template %}
		</div>
		<hr style="margin-top:0px; margin-bottom:5px; border-top:1px solid #d3d3d3">
		<footer class="container footer" style="padding:0px 0px 0px 0px; margin-bottom: 80px;">
			<h5>© 2014 - 2015 sitfish.com, all rights reserved 北京{{ brand }}科技有限公司</h5>
		</footer>
		<nav class="navbar navbar-fixed-bottom" style="min-height:45px;">
			<div class="container" style="padding:0; height:45px;">
				{% include "player.html" %}
			</div>
		</nav>
		<form>

		</form>
		<script src="//cdn.bootcss.com/jquery/2.1.1/jquery.min.js"></script>
		<script src="//cdn.bootcss.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
		<script src="{{ url_for('static', filename='script/jquery.cookie.js') }}"></script>
		<script src="{{ url_for('static', filename='script/jquery.pjax.js') }}"></script>

		<!-- SoundManager2 -->
		<script src="{{ url_for('static', filename='sm/script/soundmanager2.js') }}"></script>
		<script src="{{ url_for('static', filename='sm/script/bar-ui.js') }}"></script>

		<!-- onload -->
		<script type="text/javascript">
			$(function() {
				pjaxListener();
				refreshAll();

				playerPlayListener();
				playerPauseListener();
				playerSkipListener();
			});

			function pjaxListener() {
				$.pjax.defaults.timeout = false
				$('a[data-pjax]').pjax();
				$(document).on('pjax:complete', function() {
					$('a[data-pjax]').pjax();
					refreshAll();
				});
			}

			function refreshAll() {
				refreshNav();
				refreshSongs();

				playlistAddListener();
				playlistReplaceListener();
				playlistDeleteListener();
				playlistClearListener();
			}

			function refreshNav() {
				cur = $(location).attr('pathname');
				$('.nav-main>li').each(function() {
					var href = $(this).children('a:first').attr('href');
					if (href == cur || (href == '/toplist' && cur == '/')) {
						$(this).addClass('active');
					} else {
						$(this).removeClass('active');
					}
				});
			}

			function refreshSongs() {
				$.get('/api/v1/players/{{ uid }}', function(data) {
					loadSongs(data);
				});
			}

			function loadSongs(data) {
				if (data['ret'] == 1) {
					$('#player-playlist').empty();
					var playlist = data['player']['playlist']
					for (var i = 0; i < playlist.length; ++i) {
						var song = playlist[i];
						var time = millisecondsToTime(song['time']);
						if (i == 0) {
							$('#song-img').attr('src', song['img']);
							$('div.sm2-playlist-target').html('<ul class="sm2-playlist-bd"><li>' + song['name'] + ' - ' + song['artist_name'] + '</li></ul>');
							$('#player-playlist').append('<li class="selected"><a href="' + song['source'] + '" img="' + song['img'] + '"><table width="100%"><tr><td>' + song['name'] + '</td><td width="120px">' + song['artist_name'] + '</td><td width="80px">' + time + '</td></tr></table></a></li>');
						} else {
							$('#player-playlist').append('<li><a href="' + song['source'] + '" img="' + song['img'] + '"><table width="100%"><tr><td>' + song['name'] + '</td><td width="120px">' + song['artist_name'] + '</td><td width="80px">' + time + '</td></tr></table></a></li>');
						}
					}
					$('#song-num').html($('#player-playlist').children().length);
				}
			}

			function playlistAddListener() {
				$('.add-song').click(function() {
					data = {
						'uid': '{{ uid }}',
						'access_token': '{{ access_token }}',
						'songs': JSON.stringify([{
							'sid': $(this).attr('song-id'),
							'name': $(this).attr('song-name'),
							'source': $(this).attr('song-source'),
							'img': $(this).attr('song-img'),
							'time': $(this).attr('song-time'),
							'artist_id': $(this).attr('song-artist-id'),
							'artist_name': $(this).attr('song-artist-name')
						}])
					};
					$.post('/api/v1/player/playlist/add', data, function(data) {
						loadSongs(data);
					});
				});
			}

			function playlistReplaceListener() {
				$('.add-all').click(function() {
					songs = [];
					$('.add-song').each(function() {
						songs.push({
							'sid': $(this).attr('song-id'),
							'name': $(this).attr('song-name'),
							'source': $(this).attr('song-source'),
							'img': $(this).attr('song-img'),
							'time': $(this).attr('song-time'),
							'artist_id': $(this).attr('song-artist-id'),
							'artist_name': $(this).attr('song-artist-name')
						});
					});
					data = {
						'uid': '{{ uid }}',
						'access_token': '{{ access_token }}',
						'songs': JSON.stringify(songs)
					};
					$.post('/api/v1/player/playlist/replace', data, function(data) {
						loadSongs(data);
					});
				});
			}

			function playlistDeleteListener() {
				// TODO
			}

			function playlistClearListener() {
				// TODO
			}

			function playerPlayListener() {
				// TODO
			}

			function playerPauseListener() {
				// TODO
			}

			function playerSkipListener() {
				// TODO
			}

			function millisecondsToTime(milli) {
				function addZero(n) {
					return (n < 10 ? '0' : '') + n;
				}
				var seconds = Math.floor((milli / 1000) % 60);
				var minutes = Math.floor((milli / 60000) % 60);
				return addZero(minutes) + ":" + addZero(seconds);
			}
		</script>
	</body>
</html>
